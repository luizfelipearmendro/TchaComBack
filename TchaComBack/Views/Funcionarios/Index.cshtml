@model FuncionariosPorSetorViewModel
@{
    ViewData["Title"] = "Funcionários";
}
@functions {
    public string GetPrimeiroEUltimoNome(string nomeCompleto)
    {
        if (string.IsNullOrWhiteSpace(nomeCompleto))
            return "";

        var partes = nomeCompleto.Trim().Split(' ');

        if (partes.Length == 1)
            return partes[0];

        return $"{partes[0]} {partes[^1]}";
    }
}


<script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
<script src="~/js/Setores/setores.js" defer></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Glide.js/3.6.0/css/glide.core.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Glide.js/3.6.0/css/glide.theme.min.css" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">

<link href="~/css/Funcionarios/setores-funcionarios.css" rel="stylesheet" />
<script src="~/js/Funcionarios/setores-funcionarios.js" defer></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous" defer></script>
<title>Funcionários</title>


@if (TempData["MensagemSucesso"] != null)
{
    <div id="successAlert" class="custom-alert success">
        <span><strong>Sucesso!</strong> @TempData["MensagemSucesso"]</span>
        <span class="closebtn" onclick="closeAlert('successAlert')">&times;</span>
    </div>
    <script>
        setTimeout(() => {
            document.getElementById("successAlert").style.display = 'none';
        }, 5000);
    </script>
}

@if (TempData["MensagemErro"] != null)
{
    <div id="errorAlert" class="custom-alert error">
        <span><strong>Atenção!</strong> @TempData["MensagemErro"]</span>
        <span class="closebtn" onclick="closeAlert('errorAlert')">&times;</span>
    </div>
    <script>
        setTimeout(() => {
            document.getElementById("errorAlert").style.display = 'none';
        }, 5000);
    </script>
}

<section class="sessao-setores">
    <form asp-controller="Funcionarios" asp-action="Index" method="get" class="form-inline mb-4 text-center filtro p-4 border-2 border-gray-200 border-dashed rounded-lg dark:border-gray-700" id="id-filtro-func">
        <h1>Funcionários</h1>
        <div class="flex-form">
            <input type="hidden" name="id" value="@Model.SetorId" />
            <div class="flex-input-group filtro-content">
                <div class="input-group">
                    <p>Cargo</p>
                    <div class="mb-2 mr-sm-2 text-left selected">
                        @Html.DropDownList(
                                 "cargo",
                                 ViewBag.CargosOpcoes as SelectList,
                                 "Todos os Cargos",
                                 new { @class = "form-select selected" }
                                 )
                    </div>
                </div>
                <div class="input-group">
                    <p>Status</p>
                    <div class="mb-2 mr-sm-2 text-left selected">
                        @Html.DropDownList(
                                 "ativo",
                                 ViewBag.StatusOpcoes as SelectList,
                                 "Todos",
                                 new { @class = "form-select selected" }
                                 )
                    </div>
                </div>
            </div>
            <div class="flex-input-two filtro-content">
                <input type="text" name="searchString" value="@ViewBag.SearchString" class="form-control mb-2 mr-sm-2" placeholder="Buscar por nome..." />
                <a href="@Url.Action("Cadastrar", "Funcionarios", new { setorId = Model.SetorId, setorNome = Model.NomeSetor})" class="botao-adicionar mb-2" style="color:white;">
                    +
                </a>
                <partial name="~/Views/Componentes/Botao-Primario/BotaoPrimario.cshtml"
                         view-data='@new ViewDataDictionary(ViewData) {
                         { "Texto", "Filtrar" },
                         { "Url", "" },
                         { "ClasseExtra", "btn-filtrar" },
                         { "Id", "" },
                         { "Type", "submit" },
                         { "Elemento", "button" }
                     }' />
            </div>
            @* <button type="button" class="btn-fechar" id="toggle-filtro-func">˄</button> *@
        </div>

    </form>

    @if (Model.QuantidadeFuncAtivos == 0 && Model.QuantidadeFuncInativos == 0)
    {
        <div class="flex-mensagem-inativo">
            <div class="box-mensegem-inativo">
                <h1>Nenhum Funcionário Disponível</h1>
                <p>Infelizmente, não há funcionários vinculados a esse setor no momento. Por favor, volte em outro momento ou entre em contato com o administrador para obter mais informações.</p>
                <partial name="~/Views/Componentes/Botao-Primario/BotaoPrimario.cshtml" view-data=@(new ViewDataDictionary(ViewData){
                     { "Texto", "Voltar a Sessão" },
                     { "Url", "/Setores" },
                     { "ClasseExtra", "" },
                     { "Id", "" },
                     { "Type", "" },
                     { "elemento", "a"}
                     }) />
            </div>
        </div>
    }
    else
    {
        <div class="flex-sessao-funcionarios" id="conteudo-funcionarios">
            <div class="flex-titulo-card-funcionarios">
                <h2 class="titulo-categoria">@Model.NomeSetor</h2>
                <div class="flex-info-card-func">

                    @if (Model.QuantidadeFuncAtivos > 0 && Model.QuantidadeFuncInativos == 0)
                    {
                        @* <p class="p-func">@Model.QuantidadeFuncAtivos funcionário(s) ativo(s)</p> *@
                        <div class="flex-status">
                            <p>
                                <span class="status-green"></span>
                                <span class="status">@Model.QuantidadeFuncAtivos Ativo</span>
                            </p>
                        </div>
                    }
                    else if (Model.QuantidadeFuncInativos > 0 && Model.QuantidadeFuncAtivos == 0)
                    {
                        @* <p class="p-func">@Model.QuantidadeFuncInativos funcionário(s) inativo(s)</p> *@
                        <div class="flex-status">
                            <p>
                                <span class="status-red"></span>
                                <span class="status">@Model.QuantidadeFuncInativos Inativo</span>
                            </p>
                        </div>
                    }
                    else if (Model.QuantidadeFuncAtivos > 0 && Model.QuantidadeFuncInativos > 0)
                    {
                        @if (Model.QuantidadeFuncAtivos > 1 && Model.QuantidadeFuncInativos == 1)
                        {
                            <div class="flex-status">
                                <p>
                                    <span class="status-green"></span>
                                    <span class="status">@Model.QuantidadeFuncAtivos Ativos</span>
                                </p>
                                <p>
                                    <span class="status-red"></span>
                                    <span class="status">@Model.QuantidadeFuncInativos Inativo</span>
                                </p>
                            </div>
                        }
                        else if (Model.QuantidadeFuncAtivos == 1 && Model.QuantidadeFuncInativos > 1)
                        {
                            <div class="flex-status">
                                <p>
                                    <span class="status-green"></span>
                                    <span class="status">@Model.QuantidadeFuncAtivos Ativo</span>
                                </p>
                                <p>
                                    <span class="status-red"></span>
                                    <span class="status">@Model.QuantidadeFuncInativos Inativos</span>
                                </p>
                            </div>
                        }
                        else if (Model.QuantidadeFuncAtivos > 1 && Model.QuantidadeFuncInativos > 1)
                        {
                            <div class="flex-status">
                                <p>
                                    <span class="status-green"></span>
                                    <span class="status">@Model.QuantidadeFuncAtivos Ativos</span>
                                </p>
                                <p>
                                    <span class="status-red"></span>
                                    <span class="status">@Model.QuantidadeFuncInativos Inativos</span>
                                </p>
                            </div>
                        }
                        else
                        {
                            <div class="flex-status">
                                <p>
                                    <span class="status-green"></span>
                                    <span class="status">@Model.QuantidadeFuncAtivos Ativo</span>
                                </p>
                                <p>
                                    <span class="status-red"></span>
                                    <span class="status">@Model.QuantidadeFuncInativos Inativo</span>
                                </p>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="p-func">Nenhum funcionário encontrado</p>
                    }
                </div>

            </div>
            <div class="flex-body-funcionarios">
                @foreach (var funcionario in Model.Funcionarios)
                {
                    var acaoHtml = funcionario.Ativo == 'S'
                    ? $"<a role='button' class='rota-btn' data-bs-toggle='modal' data-bs-target='#modalDesativarFuncionario' func-id='{funcionario.Id}' func-nome='{funcionario.Nome}' data-setor='{funcionario.SetorId}'>Desativar</a>"
                    : $"<a role='button' class='rota-btn' data-bs-toggle='modal' data-bs-target='#modalReativarFuncionario' data-id='{funcionario.Id}' data-nome='{funcionario.Nome}' data-setor='{funcionario.SetorId}'>Reativar</a>";

                    var popoverHtml = $@"
                    <div class='flex-popover'>
                    <button type='button' class='close-btn btn btn-sm ' style='float:right;'>&times;</button>
                    <div class='mt-3'>
                    <a role='button' class='rota-btn editar-setor' data-bs-toggle='modal' data-bs-target='#modalEditarFuncionario' data-id='{funcionario.Id}'>Editar</a><br/>
                    {acaoHtml}
                    </div>
                    </div>";

                    <div class="card-funcionario @(funcionario.Ativo != 'S' ? "inativo" : "ativo")">
                            <div class="flex-botao-edition">
                                <button type="button"
                                        class="btn-popover"
                                        data-bs-toggle="popover"
                                        data-bs-placement="right"
                                        data-bs-html="true"
                                        data-id="@funcionario.Id"
                                        data-bs-content="@popoverHtml">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                         class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                        <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                                    </svg>
                                </button>
                             </div>
                        <div class="flex-imagem-funcionario">
                            @if (funcionario.Sexo == 'F')
                            {
                                <img src="https://i.ibb.co/WWT61zQb/image-removebg-preview.png" alt="Responsável" class="small-avatar" />
                            }
                            @if (funcionario.Sexo == 'M')
                            {
                                <img src="https://i.ibb.co/DPymZqqd/image-removebg-preview-1.png" alt="Responsável" class="small-avatar" />
                            }
                        </div>
                        <div class="flex-body-card">
                            <div class="flex-onda"></div>
                            <div class="body-card ">
                                <p><span>Nome</span> <span class="card-dado">@GetPrimeiroEUltimoNome(funcionario.Nome)</span></p>
                                <p><span>Cargo</span> <span class="card-dado">@funcionario.Cargo</span></p>
                                <p><span>Email</span> <span class="card-dado">@funcionario.Email</span></p>
                                <p><span>Telefone</span> <span class="card-dado">@funcionario.Celular</span></p>
                                <p><span>Ativo</span> <span class="card-dado">@(funcionario.Ativo == 'S' ? "Sim" : "Não")</span></p>
                                <partial name="~/Views/Componentes/Botao-Secundario/BotaoSecundario.cshtml"
                                         view-data='@new ViewDataDictionary(ViewData) {
                                         { "Texto", "Detalhar" },
                                         { "Url", "/Funcionarios" },
                                         { "ClasseExtra", "btn-detalhar" },
                                         { "Id", "botaoDetalhar" },
                                         { "Type", "button" },
                                         { "Elemento", "button" },
                                         { "Atributos", new Dictionary<string, string> {
                                             { "data-bs-toggle", "modal" },
                                             { "data-bs-target", $"#modal-{funcionario.Id}" },
                                             { "aria-expanded", "false" }
                                         }}
                                     }' />
                            </div>
                        </div>
                    </div>
                    <div  class="modal fade" id="modal-@funcionario.Id" tabindex="-1" aria-labelledby="modalLabel-@funcionario.Id" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg-custom modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="modalLabel-@funcionario.Id">@funcionario.Nome</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">

                                    <div class="container-fluid">
                                        <div class="row g-4">
                                            <div class="col-md-6">
                                                <div class="categoria">
                                                    <h5><i class="fa fa-user-circle" aria-hidden="true"></i> Informações Pessoais</h5>
                                                    <p><strong>Data de Nascimento:</strong> @funcionario.DataNascimento.ToString("dd/MM/yyyy")</p>
                                                    <p><strong>Sexo:</strong> @funcionario.Sexo</p>
                                                    <p><strong>Raça:</strong> @funcionario.RacaNav?.Raca</p>
                                                    <p><strong>Estado Civil:</strong> @funcionario.EstadoCivilNav?.EstadoCivil</p>
                                                    <p><strong>Nome da Mãe:</strong> @funcionario.NomeMae</p>
                                                    <p><strong>Naturalidade:</strong> @funcionario.Naturalidade</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="categoria">
                                                    <h5><i class="fa fa-home" aria-hidden="true"></i> Endereço</h5>
                                                    <p><strong>Endereço:</strong> @funcionario.Endereco</p>
                                                    <p><strong>Cidade:</strong> @funcionario.CidadeResidencia</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="categoria">
                                                    <h5><i class="fa fa-phone" aria-hidden="true"></i> Contato</h5>
                                                    <p><strong>Email:</strong> @funcionario.Email</p>
                                                    <p><strong>Telefone:</strong> @funcionario.Celular</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="categoria">
                                                    <h5><i class="fa fa-briefcase" aria-hidden="true"></i> Detalhes Profissionais</h5>
                                                    <p><strong>Cargo:</strong> @funcionario.Cargo</p>
                                                    <p><strong>Salário:</strong> R$ @funcionario.Salario.ToString("N2")</p>
                                                    <p><strong>Data de Ingresso:</strong> @funcionario.DataIngresso.ToString("dd/MM/yyyy")</p>
                                                    <p><strong>Dias Trabalhados:</strong> @funcionario.DiasTrabalhados</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="categoria">
                                                    <h5><i class="fa fa-calendar" aria-hidden="true"></i> Datas Importantes</h5>
                                                    <p><strong>Data de Cadastro:</strong> @funcionario.DataCadastro.ToString("dd/MM/yyyy")</p>
                                                    <p><strong>Data de Atualização:</strong> @funcionario.DataAtualizacao?.ToString("dd/MM/yyyy")</p>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                }
            </div>
        </div>
    }

</section>
<!-- modal desativar setor -->
<div class="modal fade" id="modalDesativarFuncionario" tabindex="-1" aria-labelledby="modalDesativarFuncionarioLabel" aria-hidden="true" style="z-index:100000001;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-black" id="modalDesativarFuncionarioLabel" style="font-weight:bold">Desativar Funcionário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-black">
                Tem certeza que deseja desativar o funcionário <span id="modalUserName"></span>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a id="confirmDesativeButton" role="button" class="btn btn-danger">Desativar</a>
            </div>
        </div>
    </div>
</div>

<!-- modal reativar setor -->
<div class="modal fade" id="modalReativarFuncionario" tabindex="-1" aria-labelledby="modalReativarFuncionarioLabel" aria-hidden="true" style="z-index:100000001;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-black" id="modalReativarFuncionarioLabel" style="font-weight:bold">Reativar Funcionário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-black">
                Tem certeza que deseja Reativar o funcionário <span id="modalUserNameReativo"></span>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a id="confirmReativeButton" role="button" class="btn btn-primary">Reativar</a>
            </div>
        </div>
    </div>
</div>


<script>
        document.addEventListener("DOMContentLoaded", function () {
        document.addEventListener("click", function (event) {
            if (event.target.matches("[data-bs-target='#modalDesativarFuncionario']")) {
                var button = event.target;
                var funcId = button.getAttribute('func-id');
                var funciNome = button.getAttribute('func-nome');
                var setorId = button.getAttribute('data-setor');
                var modalUserName = document.getElementById('modalUserName');
                var confirmDesativeButton = document.getElementById('confirmDesativeButton');

                if (modalUserName && funciNome) {
                    modalUserName.textContent = funciNome;
                }
                if (confirmDesativeButton && funcId && setorId) {
                    confirmDesativeButton.href = '/Funcionarios/Desativar/' + funcId + '?setorId=' + setorId;
                }
            }
        });
    });

    document.addEventListener("click", function (event) {
        if (event.target.matches("[data-bs-target='#modalReativarFuncionario']")) {
            var button = event.target;
            var funcIdReativo = button.getAttribute('data-id');
            var funcNomeReativo = button.getAttribute('data-nome');
            var setorId = button.getAttribute('data-setor');
            var modalUserNameReativo = document.getElementById('modalUserNameReativo');
            var confirmReativeButton = document.getElementById('confirmReativeButton');

            if (modalUserNameReativo && funcNomeReativo) {
                modalUserNameReativo.textContent = funcNomeReativo;
            }
            if (confirmReativeButton && funcIdReativo && setorId) {
                confirmReativeButton.href = '/Funcionarios/Reativar/' + funcIdReativo + '?setorId=' + setorId;
            }
        }
    });
</script>